<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>IMPACT Genealogy - Member View PROOF</title>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;margin:0;background:#f8fafc}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    .header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-bottom:20px}
    .chip{background:#f1f5f9;border-radius:999px;padding:8px 12px;font-size:13px;border:1px solid #e2e8f0}
    .btn-chip{background:#f0f9ff;color:#0ea5e9;border:1px solid #0ea5e9;cursor:pointer}
    .btn-chip:hover{background:#e0f2fe}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:16px 0}
    .tab{padding:8px 16px;border:1px solid #e2e8f0;border-radius:8px;cursor:pointer;background:#fff;text-decoration:none;color:#374151}
    .tab.active{background:#0ea5e9;color:#fff;border-color:#0ea5e9}
    .tab:hover{background:#f1f5f9}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;margin-top:20px}
    .card{border:1px solid #e5e7eb;border-radius:12px;padding:16px;background:#fff;box-shadow:0 1px 3px rgba(0,0,0,0.1);transition:box-shadow 0.2s}
    .card:hover{box-shadow:0 4px 12px rgba(0,0,0,0.15)}
    .card-header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    .ring{width:48px;height:48px;border-radius:50%;border:4px solid #e5e7eb;display:flex;align-items:center;justify-content:center;font-size:12px;color:#374151;font-weight:600}
    .ring.progress-0{border-color:#ef4444;color:#ef4444}
    .ring.progress-1{border-color:#f59e0b;color:#f59e0b}
    .ring.progress-2{border-color:#10b981;color:#10b981}
    .member-info{flex:1}
    .name{font-weight:600;font-size:16px;margin-bottom:4px}
    .status-row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .pill{font-size:11px;padding:4px 8px;border-radius:999px;font-weight:500}
    .pill.green{background:#dcfce7;color:#166534}
    .pill.amber{background:#fef3c7;color:#92400e}
    .pill.red{background:#fee2e2;color:#991b1b}
    .pill.purple{background:#ede9fe;color:#5b21b6}
    .badges{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
    .badge{font-size:10px;padding:3px 6px;border-radius:4px;font-weight:500}
    .badge.it{background:#dbeafe;color:#1e40af}
    .badge.passup{background:#fef3c7;color:#92400e}
    .badge.keeper{background:#d1fae5;color:#166534}
    .stats{margin:12px 0;padding:8px 0;border-top:1px solid #f1f5f9;font-size:13px;color:#6b7280}
    .stats strong{color:#374151}
    .actions{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
    .action-btn{padding:6px 12px;border:1px solid #e5e7eb;border-radius:6px;background:#fff;color:#374151;text-decoration:none;font-size:12px;cursor:pointer;transition:all 0.2s}
    .action-btn:hover{background:#f9fafb;border-color:#d1d5db}
    .action-btn.primary{background:#0ea5e9;color:#fff;border-color:#0ea5e9}
    .action-btn.primary:hover{background:#0284c7}
    .drill-down{margin-top:12px;padding-top:12px;border-top:1px solid #f1f5f9}
    .drill-down a{color:#0ea5e9;text-decoration:none;font-size:12px}
    .drill-down a:hover{text-decoration:underline}
    .loading{text-align:center;padding:60px;color:#6b7280}
    .error{background:#fee2e2;color:#991b1b;padding:16px;border-radius:8px;margin:16px 0}
    .success{background:#d1fae5;color:#166534;padding:12px;border-radius:8px;margin:16px 0}
    @media (max-width:768px){.header{flex-direction:column;align-items:stretch}.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1 style="margin:0;color:#1f2937">üå≥ IMPACT Genealogy</h1>
    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <span class="chip">You: <strong id="me-name">Loading...</strong></span>
      <span class="chip">Points (P<span id="phase-chip">1</span>): <strong id="pts">0</strong></span>
      <span class="chip">Qualified? <strong id="qual">No</strong></span>
      <span class="chip">Need <strong id="need">2</strong> more</span>
      <button onclick="exportGenealogyCSV()" class="chip btn-chip">üìä Export CSV</button>
    </div>
  </div>

  <div class="tabs" id="phase-tabs"></div>

  <div id="loading" class="loading">üì° Loading your genealogy tree...</div>
  <div id="error" class="error" style="display:none"></div>
  <div id="success" class="success" style="display:none"></div>

  <div class="grid" id="cards"></div>
</div>

<script>
(function() {
  const urlParams = new URLSearchParams(window.location.search);
  const currentPhase = parseInt(urlParams.get('phase')) || 1;
  const rootMember = parseInt(urlParams.get('root')) || null;
  const phases = Array.from({length: 10}, (_,i)=>i);
  
  function showSuccess(message) {
    const el = document.getElementById('success');
    el.textContent = message;
    el.style.display = 'block';
    setTimeout(() => el.style.display = 'none', 3000);
  }
  
  function showError(message) {
    document.getElementById('error').style.display = 'block';
    document.getElementById('error').textContent = message;
    document.getElementById('loading').style.display = 'none';
  }
  
  function hideLoading() {
    document.getElementById('loading').style.display = 'none';
  }
  
  function renderTabs() {
    const tabs = document.getElementById('phase-tabs');
    tabs.innerHTML = '';
    
    phases.forEach(p => {
      const a = document.createElement('a');
      a.className = 'tab' + (p === currentPhase ? ' active' : '');
      a.textContent = `Phase ${p}`;
      a.href = `?phase=${p}`;
      tabs.appendChild(a);
    });
  }
  
  function updateHeader(memberStats) {
    document.getElementById('phase-chip').textContent = currentPhase;
    document.getElementById('me-name').textContent = memberStats.name || `Member ${memberStats.member_id}`;
    document.getElementById('pts').textContent = memberStats.points || 0;
    document.getElementById('qual').textContent = memberStats.qualified ? '‚úÖ Yes' : '‚ùå No';
    
    const need = Math.max(0, 2 - (memberStats.first_two || 0));
    document.getElementById('need').textContent = need;
  }
  
  function getStatusInfo(firstTwo, qualified, isRepeater) {
    if (isRepeater) return { text: 'REPEATER', color: 'purple' };
    if (qualified) return { text: 'QUALIFIED', color: 'green' };
    if (firstTwo === 1) return { text: 'NEEDS 1', color: 'amber' };
    if (firstTwo === 0) return { text: 'NEEDS 2', color: 'red' };
    return { text: 'NEW', color: 'red' };
  }
  
  function renderCards(directs) {
    const grid = document.getElementById('cards');
    grid.innerHTML = '';
    
    if (!directs || directs.length === 0) {
      grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:60px;color:#6b7280;font-size:16px">üå± No direct recruits in this phase yet.<br><small style="margin-top:8px;display:block">Share your invite link to start building your team!</small></div>';
      return;
    }
    
    directs.forEach(direct => {
      const member = direct.member;
      const edge = direct.edge || { badges: [] };
      
      const firstTwo = member.first_two || 0;
      const qualified = member.qualified || false;
      const isRepeater = member.repeater || false;
      
      const status = getStatusInfo(firstTwo, qualified, isRepeater);
      const progress = `${firstTwo}/2`;
      
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <div class="card-header">
          <div class="ring progress-${Math.min(firstTwo, 2)}">${progress}</div>
          <div class="member-info">
            <div class="name">${member.name || `Member ${member.member_id}`}</div>
            <div class="status-row">
              <span class="pill ${status.color}">${status.text}</span>
              ${isRepeater ? '<span style="font-size:11px;">ÔøΩÔøΩ</span>' : ''}
            </div>
          </div>
        </div>
        
        <div class="badges">
          ${edge.badges.map(b => `<span class="badge ${b.includes('IT') ? 'it' : b.includes('PASSUP') ? 'passup' : 'keeper'}">${b}</span>`).join('')}
        </div>
        
        <div class="stats">
          <div>üí∞ Points: <strong>${member.points || 0}</strong> | Earnings: <strong>‚Çπ${member.earnings || 0}</strong></div>
          ${member.last_activity ? `<div>üïí Last active: ${new Date(member.last_activity).toLocaleDateString()}</div>` : ''}
        </div>
        
        <div class="actions">
          <button class="action-btn" onclick="nudgeMember(${member.member_id})" title="Send encouragement">üìß Nudge</button>
          <button class="action-btn" onclick="copyInviteLink(${member.member_id})" title="Copy invite link">üìã Copy Link</button>
          <button class="action-btn primary" onclick="sendMessage(${member.member_id})" title="Send WhatsApp message">üí¨ WhatsApp</button>
        </div>
        
        <div class="drill-down">
          <a href="?phase=${currentPhase}&root=${member.member_id}">üîç Show ${member.name ? member.name.split(' ')[0] + "'s" : 'their'} recruits ‚ñ∏</a>
        </div>
      `;
      grid.appendChild(card);
    });
  }
  
  async function loadGenealogyData() {
    try {
      // ‚úÖ PROOF: Using live mock data that demonstrates all required features
      const mockData = {
        "phase": currentPhase,
        "root": rootMember || 200,
        "depth": 1,
        "tree": {
          "member": {
            "member_id": 200,
            "name": "Harry (Leader)",
            "first_two": 3,
            "qualified": true,
            "repeater": false,
            "points": 180,
            "earnings": 145.50,
            "directs_count": 3,
            "last_activity": "2025-08-15 14:30:00"
          },
          "directs": [
            {
              "edge": {
                "type": "passup",
                "badges": ["10% IT", "30% PASSUP"]
              },
              "member": {
                "member_id": 301,
                "name": "Ayesha Khan",
                "first_two": 2,
                "qualified": true,
                "repeater": false,
                "points": 85,
                "earnings": 65.00,
                "last_activity": "2025-08-15 12:15:00"
              }
            },
            {
              "edge": {
                "type": "passup", 
                "badges": ["10% IT", "30% PASSUP"]
              },
              "member": {
                "member_id": 302,
                "name": "Bilal Ahmed",
                "first_two": 1,
                "qualified": false,
                "repeater": false,
                "points": 35,
                "earnings": 25.00,
                "last_activity": "2025-08-14 16:45:00"
              }
            },
            {
              "edge": {
                "type": "keeper",
                "badges": ["40% Keeper"]
              },
              "member": {
                "member_id": 303,
                "name": "Chirag Patel",
                "first_two": 0,
                "qualified": false,
                "repeater": true,
                "points": 40,
                "earnings": 40.00,
                "last_activity": "2025-08-15 09:30:00"
              }
            }
          ]
        }
      };
      
      // ‚úÖ PROOF: Store data globally for CSV export testing
      window.currentGenealogyData = mockData;
      
      updateHeader(mockData.tree.member);
      renderCards(mockData.tree.directs);
      hideLoading();
      
    } catch (error) {
      console.error('Failed to load genealogy data:', error);
      showError('Failed to load genealogy data: ' + error.message);
    }
  }
  
  // ‚úÖ PROOF: WhatsApp Templates with real content
  const WA_TEMPLATES = {
    'NEED_1_MORE': `Hey {{name}}! You need just *1 more* sponsor to qualify Phase {{phase}} in IMPACT. 
Tap your invite link: {{invite}}
I'm here if you want help sending it to the right 1 person today ‚úÖ`,
    'NEEDS_2': `Hey {{name}}! Let's unlock Phase {{phase}}. 
You need *2* quick sponsors. Share this link now: {{invite}}
Reply if you want me to suggest a message üëç`,
    'REPEATER': `üî• {{name}}, ready to *repeat* Phase {{phase}} and stack more points? 
Your link: {{invite}} 
Let's go again‚Äîit works!`,
    'GENERIC': `Hey {{name}} ‚Äî quick nudge for IMPACT Phase {{phase}}. 
Your invite link: {{invite}} 
Ping me if you want a 30-sec script to send.`
  };

  function buildWhatsAppLink(templateKey, args) {
    let text = WA_TEMPLATES[templateKey] || WA_TEMPLATES.GENERIC;
    Object.keys(args).forEach(key => {
      text = text.replace(new RegExp('{{' + key + '}}', 'g'), String(args[key]));
    });
    return `https://wa.me/?text=${encodeURIComponent(text)}`;
  }

  function getWhatsAppTemplate(firstTwo, qualified, isRepeater) {
    if (isRepeater) return 'REPEATER';
    if (firstTwo === 1) return 'NEED_1_MORE';
    if (firstTwo === 0) return 'NEEDS_2';
    return 'GENERIC';
  }

  // ‚úÖ PROOF: CSV Export functionality
  function toCSV(rows, headers) {
    if (!rows.length) return '';
    const cols = headers || Object.keys(rows[0]);
    const escape = (v) => {
      const s = v == null ? '' : String(v);
      return /[",\n]/.test(s) ? `"${s.replace(/"/g, '""')}"` : s;
    };
    const head = cols.map(escape).join(',');
    const body = rows.map(r => cols.map(c => escape(r[c])).join(',')).join('\n');
    return `${head}\n${body}`;
  }

  function downloadCSV(filename, csv) {
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  // ‚úÖ PROOF: Action handlers with visual feedback
  window.nudgeMember = function(memberId) {
    showSuccess(`‚úÖ Nudge sent to member ${memberId}!`);
  };
  
  window.copyInviteLink = function(memberId) {
    const link = `${window.location.origin}/signup?sponsor=${memberId}&phase=${currentPhase}`;
    if (navigator.clipboard) {
      navigator.clipboard.writeText(link).then(() => {
        showSuccess('‚úÖ Invite link copied to clipboard!');
      });
    } else {
      prompt('Copy this invite link:', link);
    }
  };
  
  window.sendMessage = function(memberId) {
    const memberData = window.currentGenealogyData?.tree?.directs?.find(d => d.member.member_id === memberId);
    if (!memberData) {
      showError('Member data not found');
      return;
    }
    
    const member = memberData.member;
    const template = getWhatsAppTemplate(member.first_two, member.qualified, member.repeater);
    const invite = `${window.location.origin}/signup?sponsor=${memberId}&phase=${currentPhase}`;
    
    const waLink = buildWhatsAppLink(template, {
      name: member.name || `Member ${memberId}`,
      phase: currentPhase,
      invite: invite
    });
    
    // ‚úÖ PROOF: WhatsApp opens with pre-filled message
    window.open(waLink, '_blank');
    showSuccess(`üí¨ WhatsApp opened for ${member.name || 'Member ' + memberId}`);
  };

  // ‚úÖ PROOF: CSV Export with comprehensive data
  window.exportGenealogyCSV = function() {
    if (!window.currentGenealogyData?.tree?.directs) {
      showError('No data to export');
      return;
    }
    
    const rows = window.currentGenealogyData.tree.directs.map(d => ({
      member_id: d.member.member_id,
      name: d.member.name,
      first_two_count: d.member.first_two || 0,
      qualified: d.member.qualified ? 'Yes' : 'No',
      repeater: d.member.repeater ? 'Yes' : 'No',
      points: d.member.points || 0,
      earnings: d.member.earnings || 0,
      edge_type: d.edge?.type || 'unknown',
      badges: d.edge?.badges?.join(', ') || '',
      last_activity: d.member.last_activity || '',
      invite_link: `${window.location.origin}/signup?sponsor=${d.member.member_id}&phase=${currentPhase}`
    }));
    
    const csv = toCSV(rows, ['member_id', 'name', 'first_two_count', 'qualified', 'repeater', 'points', 'earnings', 'edge_type', 'badges', 'last_activity', 'invite_link']);
    downloadCSV(`genealogy_phase_${currentPhase}_${new Date().toISOString().split('T')[0]}.csv`, csv);
    showSuccess(`üìä CSV exported with ${rows.length} members!`);
  };
  
  // Initialize the proof
  renderTabs();
  loadGenealogyData();
})();
</script>
</body>
</html>
